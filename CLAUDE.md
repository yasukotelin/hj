# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

fzfを使用したz風のディレクトリ履歴ジャンプ機能を提供するシェルスクリプトです。frecency（頻度 + 最近性）アルゴリズムでディレクトリの使用状況を追跡し、インタラクティブな選択インターフェースで素早いナビゲーションを可能にします。

## アーキテクチャ

### 主要コンポーネント

**hj.sh** - 全機能を含む単一のシェルスクリプト:

- `hj()` - 引数解析を含むメインコマンド関数（--help, --list, インタラクティブモード）
- `hj_calculate_frecency_and_sort()` - frecencyスコアを計算し、関連度でディレクトリをソート
- `hj_age_history()` - 履歴エントリの自動エイジング/クリーンアップを処理
- `cd()` - 組み込みcdコマンドをオーバーライドしてディレクトリ変更を追跡

### 履歴管理

**データ形式**: `~/.hj_history`に`パス|ランク|タイムスタンプ`で保存

**Frecencyアルゴリズム**:
- 新しいディレクトリはランク1.0でスタート
- 各訪問でランクが1.0増加
- 時間減衰係数: 1時間以内（4倍）、1日以内（2倍）、1週間以内（1倍）、それ以上（0.5倍）
- 最終スコア = ランク × 時間係数

**メンテナンス**:
- 1000エントリ超過時の自動エイジング（全ランクを0.99倍）
- ランク1.0未満のエントリを削除
- 存在しないディレクトリをフィルタリング

## ツールのテスト

```bash
# スクリプトを読み込み
source hj.sh

# 基本機能をテスト
cd /tmp
cd ~
hj --list  # frecencyソート済みの履歴を表示

# インタラクティブ選択をテスト
hj  # ディレクトリ履歴でfzfを開く

# ヘルプをテスト
hj --help
```

## よくある問題

**コマンドパスの問題**: スクリプトは異なるシェル環境でのPATH問題を避けるため、コマンドのフルパス（`/bin/date`, `/usr/bin/awk`など）を使用しています。

**シェル環境**: cd()のオーバーライドはエラー発生時にシェル環境を破壊する可能性があります。全ての関数は`2>/dev/null || true`パターンでエラーハンドリングを含んでいます。

**ローカル変数**: シェル関数での変数漏洩を防ぐため、常にローカル変数を明示的に初期化してください（例：`local time_factor=1`）。

## 開発時の注意点

frecencyアルゴリズムや履歴管理を変更する際は:

1. 空の履歴ファイルと内容のある履歴ファイルの両方でテスト
2. 読み込み後もシェルコマンド（vim、gitなど）が動作することを確認
3. fzf統合がエッジケース（空の履歴、キャンセル選択）を適切に処理することをチェック
4. 全ての一時ファイルが適切にクリーンアップされることを確認

このスクリプトは様々なシェル環境やコマンド可用性の問題に対して堅牢になるよう設計されています。